<UserControl x:Class="TestCaseEditorApp.MVVM.Views.TestCaseGenerator_QuestionsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:TestCaseEditorApp.MVVM.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="520" d:DesignWidth="800"
             Background="Transparent">

    <UserControl.Resources>
        <!-- Local fallback converter if the project doesn't define one globally -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <SolidColorBrush x:Key="ListViewBackgroundBrush" Color="#F3F4F6"/>
    </UserControl.Resources>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Top bar -->
            <RowDefinition Height="Auto"/>
            <!-- Chips -->
            <RowDefinition Height="*"/>
            <!-- Questions list -->
            <RowDefinition Height="Auto"/>
            <!-- Footer / smart button -->
        </Grid.RowDefinitions>

        <!-- Top row omitted here for brevity; keep the version you already have (verification/presets controls) -->

        <!-- Chips row -->
        <ItemsControl Grid.Row="1" ItemsSource="{Binding FilteredDefaults}" Margin="0,4,0,8">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <!-- Bind to Name and Description (DefaultItem properties) -->
                    <ToggleButton Style="{StaticResource PillToggleStyle}"
                                  Content="{Binding Name}"
                                  IsChecked="{Binding IsEnabled, Mode=TwoWay}"
                                  ToolTip="{Binding Description}" Margin="4,4,0,0"/>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Questions: use a ListView for virtualization and selectable items -->
        <Border Grid.Row="2" BorderThickness="1" BorderBrush="{StaticResource CardBorderBrush}" CornerRadius="4" Padding="6" Background="Transparent">
            <ListView ItemsSource="{Binding PendingQuestions}"
                      SelectedItem="{Binding SelectedClarifyingQuestion, Mode=TwoWay}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      Background="{StaticResource ListViewBackgroundBrush}">
                <ListView.ItemTemplate>
                    <DataTemplate DataType="{x:Type local:ClarifyingQuestionVM}">
                        <Border Padding="8" Margin="0,6,0,6" BorderBrush="{StaticResource CardBorderBrush}" BorderThickness="1" CornerRadius="4" Background="{StaticResource ListViewBackgroundBrush}">
                            <StackPanel>
                                <DockPanel>
                                    <TextBlock Text="{Binding Category}" FontSize="11" Foreground="{StaticResource MenuForeground}" DockPanel.Dock="Left" Margin="0,0,8,0"/>

                                    <!-- Severity text -->
                                    <TextBlock x:Name="SeverityText" Text="{Binding Severity}" FontWeight="Bold" DockPanel.Dock="Left" Margin="0,0,8,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource MenuForeground}" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Severity}" Value="MUST">
                                                        <Setter Property="Foreground" Value="{StaticResource Accent}" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Severity}" Value="SHOULD">
                                                        <Setter Property="Foreground" Value="{StaticResource AccentForeground}" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Severity}" Value="OPTIONAL">
                                                        <Setter Property="Foreground" Value="{StaticResource MenuForeground}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBlock Text="{Binding Text}" TextWrapping="Wrap" FontWeight="SemiBold"/>
                                </DockPanel>

                                <TextBlock Text="{Binding Rationale}" Margin="0,6,0,6" TextWrapping="Wrap" Foreground="#444" FontStyle="Italic"/>

                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,6,0,0">
                                    <TextBlock Text="Answer:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBox Text="{Binding Answer, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="420" AcceptsReturn="True" Height="60" TextWrapping="Wrap" />
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0" >
                                    <Button Style="{StaticResource PillActionButtonStyle}" Content="Set as assumption"
                                            Command="{Binding DataContext.SetAsAssumptionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}" Margin="0,0,8,0"/>
                                    <Button Style="{StaticResource PillActionButtonStyle}" Content="Accept"
                                            Command="{Binding DataContext.AcceptQuestionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}" Margin="0,0,8,0"/>
                                    <Button Style="{StaticResource PillActionButtonStyle}" Content="Resolve"
                                            Command="{Binding DataContext.MarkResolvedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}" />
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Border>

        <!-- Footer: smart action / secondary -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
            <Button Style="{StaticResource MenuPopupButtonStyle}" Content="Reset Assumptions" Command="{Binding ResetAssumptionsCommand}" Margin="0,0,8,0"/>
            <Button Style="{StaticResource MenuPopupButtonStyle}" Content="{Binding SmartButtonLabel}" Command="{Binding SmartButtonCommand}" Padding="12,6" MinWidth="160"
                    IsEnabled="{Binding CanExecuteSmartButton}" />
        </StackPanel>
    </Grid>
</UserControl>