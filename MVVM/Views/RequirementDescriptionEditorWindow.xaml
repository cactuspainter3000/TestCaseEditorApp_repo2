<Window x:Class="TestCaseEditorApp.MVVM.Views.RequirementDescriptionEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Width="800" 
        Height="600" 
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent">
    
    <Border Background="{DynamicResource MenuBackground}" 
            BorderBrush="{DynamicResource AccentBrush}" 
            BorderThickness="1" 
            CornerRadius="8">
        <Grid Margin="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/><!-- Custom Title Bar -->
                <RowDefinition Height="*"/>   <!-- Text Editor -->
                <RowDefinition Height="Auto"/><!-- Buttons -->
            </Grid.RowDefinitions>

            <!-- Custom Title Bar -->
            <Border Grid.Row="0" 
                    Background="{DynamicResource MenuBackground}" 
                    CornerRadius="8,8,0,0" 
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid Height="32">
                    <TextBlock Text="{Binding WindowTitle, FallbackValue='Edit Requirement Description'}"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               Foreground="White"
                               FontSize="12"
                               Margin="40,0"/>
                    <!-- Close button -->
                    <Button HorizontalAlignment="Right"
                            VerticalAlignment="Center"
                            Margin="0,0,8,0"
                            Width="24" Height="24"
                            Content="✕"
                            FontSize="12"
                            Click="Close_Click"
                            Style="{StaticResource IconButtonStyle}"/>
                </Grid>
            </Border>

            <!-- Text Editor -->
            <Border Grid.Row="1"
                    Background="#2D2D30"
                    BorderBrush="{DynamicResource AccentBrush}"
                    BorderThickness="1"
                    Margin="16,16,16,16">
                <TextBox x:Name="DescriptionTextBox"
                         Text="{Binding EditedDescription, UpdateSourceTrigger=PropertyChanged}"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto"
                         HorizontalScrollBarVisibility="Disabled"
                         Foreground="White"
                         CaretBrush="{DynamicResource AccentBrush}"
                         Background="Transparent"
                         BorderThickness="0"
                         Padding="12"
                         FontSize="13"
                         FontFamily="Segoe UI"/>
            </Border>

            <!-- Button Panel -->
            <StackPanel Grid.Row="2" 
                        Orientation="Horizontal" 
                        HorizontalAlignment="Right"
                        Margin="16,0,16,16">
                <Button Content="Cancel"
                        Click="Cancel_Click"
                        Padding="16,8"
                        Margin="0,0,8,0"
                        FontSize="13"
                        ToolTip="Cancel editing and close without saving changes"
                        IsEnabled="{Binding IsNotAnalyzing}">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{DynamicResource Brush.Text.Primary}"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Root" 
                                                Background="{TemplateBinding Background}"
                                                CornerRadius="{DynamicResource Radius.SM}"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Root" Property="Background" Value="{DynamicResource Brush.Background.Menu.Hover}"/>
                                            </Trigger>
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter TargetName="Root" Property="Background" Value="#2E2E32"/>
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Opacity" Value="0.5"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
                <Button Click="ReAnalyze_Click"
                        Padding="16,8"
                        FontSize="13"
                        IsEnabled="{Binding IsNotAnalyzing}">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Content" Value="Re-Analyze"/>
                            <Setter Property="ToolTip" Value="Save changes and immediately re-analyze this requirement"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{DynamicResource Brush.Text.Primary}"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Root" 
                                                Background="{TemplateBinding Background}"
                                                CornerRadius="{DynamicResource Radius.SM}"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Root" Property="Background" Value="{DynamicResource Brush.Background.Menu.Hover}"/>
                                            </Trigger>
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter TargetName="Root" Property="Background" Value="#2E2E32"/>
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Opacity" Value="0.5"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsBatchAnalyzing}" Value="True">
                                    <Setter Property="Content" Value="Queue for Re-Analysis"/>
                                    <Setter Property="ToolTip" Value="Save changes and queue this requirement for re-analysis when batch processing completes"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                
                <!-- Debug button to inspect what's being sent to LLM -->
                <Button Content="Inspect Prompt"
                        Click="InspectPrompt_Click"
                        Padding="16,8"
                        Margin="8,0"
                        FontSize="13"
                        ToolTip="Show the exact prompt being sent to the LLM for analysis (debugging)">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="#FFA500"/>  <!-- Orange color for debug feature -->
                            <Setter Property="BorderBrush" Value="#FFA500"/>
                            <Setter Property="BorderThickness" Value="1"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Root" 
                                                Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                CornerRadius="{DynamicResource Radius.SM}"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Root" Property="Background" Value="#33FFA500"/>
                                            </Trigger>
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter TargetName="Root" Property="Background" Value="#66FFA500"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
            </StackPanel>

            <!-- Spinner Overlay (shown during analysis) -->
            <Grid Grid.Row="0" Grid.RowSpan="3"
                  Background="#99000000"
                  Visibility="{Binding IsAnalyzingInEditor, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock Text="●" 
                               FontSize="48" 
                               Foreground="{DynamicResource AccentBrush}"
                               HorizontalAlignment="Center"
                               RenderTransformOrigin="0.5,0.5">
                        <TextBlock.RenderTransform>
                            <RotateTransform x:Name="SpinTransform"/>
                        </TextBlock.RenderTransform>
                        <TextBlock.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation Storyboard.TargetName="SpinTransform"
                                                       Storyboard.TargetProperty="Angle"
                                                       From="0" To="360" Duration="0:0:2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </TextBlock.Triggers>
                    </TextBlock>
                    <TextBlock Text="Analyzing requirement..."
                               Foreground="White"
                               FontSize="14"
                               Margin="0,16,0,0"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</Window>
