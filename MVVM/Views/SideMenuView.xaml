<UserControl x:Class="TestCaseEditorApp.MVVM.Views.SideMenuView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:conv="clr-namespace:TestCaseEditorApp.Converters"
             xmlns:controls="clr-namespace:TestCaseEditorApp.Controls"
             xmlns:vm="clr-namespace:TestCaseEditorApp.MVVM.ViewModels" d:DataContext="{d:DesignInstance Type=vm:MainViewModel, IsDesignTimeCreatable=False}"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="200">

    

        <!-- Local resources: converters and small fallbacks to keep XAML designer happy -->
    <UserControl.Resources>
        <conv:SectionSelectedConverter x:Key="SectionSelectedConverter" />
        <conv:BoolToAngleConverter x:Key="BoolToAngleConverter" />
        <conv:AllTrueToVisibilityConverter x:Key="AllTrueToVisibilityConverter" />

        <!-- Small Grid style used by item templates -->
        <Style x:Key="StepItemGridStyle" TargetType="Grid">
            <Setter Property="Margin" Value="0,2,0,2"/>
        </Style>

        <!-- Fallback StepDescriptorTemplate so this file compiles even if your app defines it elsewhere.
             Replace/remove if you have a richer shared template in resources. -->
        <DataTemplate x:Key="StepDescriptorTemplate">
            <Grid Margin="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock Text="{Binding DisplayName}" Foreground="White" VerticalAlignment="Center" />
                <TextBlock Grid.Column="1" Text="{Binding Badge}" Foreground="DarkOrange" Margin="8,0,0,0" VerticalAlignment="Center"/>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <Border Style="{StaticResource MenuSectionBorderStyle}">
        <Grid Background="#252525" Margin="5">
            <StackPanel>

                <!-- Test Case Creator header -->
                <ToggleButton x:Name="TestCaseCreatorToggle"
                              Style="{StaticResource MenuHeaderToggleStyle}"
                              HorizontalAlignment="Stretch"
                              Cursor="Hand"
                              Margin="0,6,0,0"
                              IsChecked="{Binding SelectedMenuSection, Converter={StaticResource SectionSelectedConverter}, ConverterParameter=TestCase, Mode=TwoWay}">
                    <TextBlock Text="Test Case Creator" Style="{StaticResource MenuHeaderTheme}" />
                </ToggleButton>

                <!-- Animated expanded area -->
                <Border Margin="0,4,0,0" Padding="0" Background="Transparent" ClipToBounds="True">
                    <Border.LayoutTransform>
                        <ScaleTransform ScaleY="0" />
                    </Border.LayoutTransform>
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Opacity" Value="0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TestCaseCreatorToggle}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="1" Duration="0:0:0.20" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.14" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="0" Duration="0:0:0.16" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.12" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <!-- Cleaned ListBox / item template fragment for the Steps list -->
                    <StackPanel>

                        <!-- Steps list -->
                        <ListBox x:Name="StepsListBox"
             ItemsSource="{Binding TestCaseCreationSteps}"
             SelectedItem="{Binding SelectedStep, Mode=TwoWay}"
             Background="Transparent"
             BorderThickness="0"
             SelectionMode="Single"
             Margin="0"
             d:ItemsSource="{d:SampleData ItemCount=5}"
             SelectionChanged="StepsListBox_SelectionChanged">
                            <!-- Fixed ListBox.ItemTemplate fragment -->
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <Grid Style="{StaticResource StepItemGridStyle}" MinHeight="28">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                        <!-- Left: label + badge -->
                                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock x:Name="TitleText"
                     Text="{Binding DisplayName}"
                     Foreground="White"
                     VerticalAlignment="Center"
                     FontWeight="Normal"/>
                                                <TextBlock Text="{Binding Badge}"
                     Foreground="DarkOrange"
                     Margin="8,0,0,0"
                     VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Right: Chevron toggle button -->
                                        <ToggleButton Grid.Column="1" 
                                                      IsChecked="{Binding IsFileMenuExpanded, Mode=TwoWay}"
                                                      Width="20" Height="20"
                                                      Margin="0,0,6,0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Right"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      Cursor="Hand">
                                            <ToggleButton.Visibility>
                                                <MultiBinding Converter="{StaticResource AllTrueToVisibilityConverter}">
                                                    <Binding Path="HasFileMenu" />
                                                    <Binding Path="IsSelected" RelativeSource="{RelativeSource AncestorType=ListBoxItem}" />
                                                </MultiBinding>
                                            </ToggleButton.Visibility>
                                            <ToggleButton.RenderTransform>
                                                <RotateTransform x:Name="ChevronRotation" Angle="0" CenterX="10" CenterY="10"/>
                                            </ToggleButton.RenderTransform>
                                            <ToggleButton.Style>
                                                <Style TargetType="ToggleButton">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="ToggleButton">
                                                                <Border Background="{TemplateBinding Background}">
                                                                    <Viewbox Width="12" Height="12" Stretch="Uniform">
                                                                        <Canvas Width="12" Height="12">
                                                                            <Path Data="M2,5 L6,9 L10,5"
                                                                                  Stroke="White"
                                                                                  StrokeThickness="2"
                                                                                  StrokeStartLineCap="Round"
                                                                                  StrokeEndLineCap="Round"
                                                                                  StrokeLineJoin="Round" />
                                                                        </Canvas>
                                                                    </Viewbox>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Trigger.EnterActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                         To="180" Duration="0:0:0.2" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.EnterActions>
                                                            <Trigger.ExitActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                         To="0" Duration="0:0:0.2" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.ExitActions>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ToggleButton.Style>
                                        </ToggleButton>
                                    </Grid>
                                    
                                    <!-- Expandable file menu section -->
                                    <Border x:Name="FileMenuExpander" 
                                            Background="{StaticResource MenuListBackground}"
                                            BorderBrush="#33000000"
                                            BorderThickness="0,1,0,0"
                                            Margin="4,0,4,0"
                                            MaxHeight="0"
                                            Opacity="0">
                                        <Border.LayoutTransform>
                                            <ScaleTransform ScaleY="0" />
                                        </Border.LayoutTransform>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFileMenuExpanded}" Value="True">
                                                        <DataTrigger.EnterActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="500" Duration="0:0:0.25" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="1" Duration="0:0:0.25" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="1" Duration="0:0:0.2" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.EnterActions>
                                                        <DataTrigger.ExitActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="0" Duration="0:0:0.2" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="0" Duration="0:0:0.2" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="0" Duration="0:0:0.15" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.ExitActions>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Margin="12,8">
                                            <Button Command="{Binding DataContext.ImportWordCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    Style="{StaticResource MenuPopupButtonStyle}">
                                                <TextBlock Text="Import New Requirements…" />
                                            </Button>
                                            <Button Command="{Binding DataContext.LoadWorkspaceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    Style="{StaticResource MenuPopupButtonStyle}">
                                                <TextBlock Text="Import In-Process Requirements…" />
                                            </Button>

                                            <Separator Margin="0,6"/>

                                            <Button Command="{Binding DataContext.SaveWorkspaceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    Style="{StaticResource MenuPopupButtonStyle}">
                                                <TextBlock Text="Save Workspace" />
                                            </Button>

                                            <Separator Margin="0,6"/>

                                            <Button Command="{Binding DataContext.ReloadCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    Style="{StaticResource MenuPopupButtonStyle}">
                                                <TextBlock Text="Reload Source (from DOCX)" />
                                            </Button>

                                            <Button Command="{Binding DataContext.ExportAllToJamaCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    Style="{StaticResource MenuPopupButtonStyle}">
                                                <TextBlock Text="Export All to Jama…" />
                                            </Button>

                                            <Separator Margin="0,8"/>

                                            <Button Command="{Binding DataContext.HelpCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    Style="{StaticResource MenuPopupButtonStyle}">
                                                <TextBlock Text="Help" />
                                            </Button>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                            </ListBox.ItemTemplate>
                            <!-- Item container style: left 4px accent stripe for selection -->
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Padding" Value="0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>

                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Outer" Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="4" />
                                                            <ColumnDefinition Width="*" />
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Selection stripe -->
                                                        <Border x:Name="SelectionStripe" Grid.Column="0" Background="{DynamicResource HeaderAccentBrush}" Visibility="Collapsed" />

                                                        <ContentPresenter Grid.Column="1"
                                                      Content="{TemplateBinding Content}"
                                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                                      Margin="0"
                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                                    </Grid>
                                                </Border>

                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="SelectionStripe" Property="Visibility" Value="Visible"/>
                                                    </Trigger>

                                                    <Trigger Property="IsEnabled" Value="False">
                                                        <Setter Property="Opacity" Value="0.55"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                        </ListBox>
                    </StackPanel>
                </Border>

                <!-- Test Flow Creator group -->
                <ToggleButton x:Name="TestFlowCreatorToggle"
                              Style="{StaticResource MenuHeaderToggleStyle}"
                              HorizontalAlignment="Stretch"
                              Cursor="Hand"
                              Margin="0,6,0,0"
                              IsChecked="{Binding SelectedMenuSection, Converter={StaticResource SectionSelectedConverter}, ConverterParameter=TestFlow, Mode=TwoWay}">
                    <TextBlock Text="Test Flow Creator" Style="{StaticResource MenuHeaderTheme}" />
                </ToggleButton>

                <Border Margin="0,4,0,0" Padding="0" Background="Transparent" ClipToBounds="True">
                    <Border.LayoutTransform>
                        <ScaleTransform ScaleY="0" />
                    </Border.LayoutTransform>

                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Opacity" Value="0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TestFlowCreatorToggle}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="1" Duration="0:0:0.20" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.14" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="0" Duration="0:0:0.16" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.12" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <!-- Inline fallback item template used if your shared StepDescriptorTemplate is not present -->
                    <ListBox ItemsSource="{Binding TestFlowSteps}"
                             SelectedItem="{Binding SelectedFlowStep, Mode=TwoWay}"
                             Background="Transparent"
                             BorderThickness="0"
                             SelectionMode="Single"
                             Margin="0">
                        <ListBox.ItemTemplate>
                            <StaticResource ResourceKey="StepDescriptorTemplate"/>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>

                <TextBlock VerticalAlignment="Bottom"
                           Text="{Binding SapStatus}"
                           HorizontalAlignment="Center"
                           Foreground="{Binding SapForegroundStatus}"
                           Style="{StaticResource MenuHeaderTheme}"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>