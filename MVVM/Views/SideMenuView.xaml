<UserControl x:Class="TestCaseEditorApp.MVVM.Views.SideMenuView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:conv="clr-namespace:TestCaseEditorApp.Converters"
             xmlns:controls="clr-namespace:TestCaseEditorApp.Controls"
             xmlns:localControls="clr-namespace:TestCaseEditorApp.MVVM.Controls"
             xmlns:vm="clr-namespace:TestCaseEditorApp.MVVM.ViewModels" d:DataContext="{d:DesignInstance Type=vm:MainViewModel, IsDesignTimeCreatable=False}"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="200">

    

        <!-- Local resources: converters only -->
    <UserControl.Resources>
        <conv:SectionSelectedConverter x:Key="SectionSelectedConverter" />
        <conv:AllTrueToVisibilityConverter x:Key="AllTrueToVisibilityConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </UserControl.Resources>

    <Border Background="#2B2B2B" CornerRadius="4" Margin="0" BorderBrush="{StaticResource Brush.Accent.Primary}" BorderThickness="2">
        <Grid Background="{StaticResource Brush.Background.Menu}" Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <ScrollViewer.Resources>
                    <Style TargetType="ScrollBar" BasedOn="{StaticResource CustomScrollBarStyle}"/>
                </ScrollViewer.Resources>
                <StackPanel>

                <!-- Test Case Generator header -->
                <ToggleButton x:Name="TestCaseGeneratorToggle"
                              Style="{StaticResource ActionToggleButton}"
                              HorizontalAlignment="Stretch"
                              Cursor="Hand"
                              Margin="0,6,0,0"
                              IsChecked="{Binding SelectedMenuSection, Converter={StaticResource SectionSelectedConverter}, ConverterParameter=TestCase, Mode=TwoWay}">
                    <TextBlock Text="Test Case Generator" FontSize="16" FontWeight="Normal" />
                </ToggleButton>

                <!-- Animated expanded area -->
                <Border Margin="0,4,0,0" Padding="0" Background="Transparent" ClipToBounds="True">
                    <Border.LayoutTransform>
                        <ScaleTransform ScaleY="0" />
                    </Border.LayoutTransform>
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Opacity" Value="0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TestCaseGeneratorToggle}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="1" Duration="0:0:0.20" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.14" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="0" Duration="0:0:0.16" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.12" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <!-- Cleaned ListBox / item template fragment for the Steps list -->
                    <StackPanel>

                        <!-- Steps list -->
                        <ListBox x:Name="StepsListBox"
             ItemsSource="{Binding TestCaseGeneratorSteps}"
             SelectedItem="{Binding SelectedStep, Mode=TwoWay}"
             Background="Transparent"
             BorderThickness="0"
             SelectionMode="Single"
             Margin="0"
             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
             d:ItemsSource="{d:SampleData ItemCount=5}"
             SelectionChanged="StepsListBox_SelectionChanged">
                            <!-- Fixed ListBox.ItemTemplate fragment -->
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <Grid MinHeight="28" Background="Transparent">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                        <!-- Left: label + badge -->
                                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6"
                                                    MouseLeftButtonDown="MainContent_MouseLeftButtonDown" Background="Transparent">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock x:Name="TitleText"
                     Text="{Binding DisplayName}"
                     Foreground="#CCCCCC"
                     VerticalAlignment="Center"
                     FontSize="13"
                     FontWeight="Normal"/>
                                                <TextBlock Text="{Binding Badge}"
                     Foreground="DarkOrange"
                     Margin="8,0,0,0"
                     VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Right: Chevron toggle button -->
                                        <ToggleButton Grid.Column="1" 
                                                      IsChecked="{Binding IsFileMenuExpanded, Mode=TwoWay}"
                                                      Width="20" Height="20"
                                                      Margin="0,0,4,0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Center"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      Cursor="Hand">
                                            <ToggleButton.Visibility>
                                                <MultiBinding Converter="{StaticResource AllTrueToVisibilityConverter}">
                                                    <Binding Path="HasFileMenu" />
                                                    <Binding Path="IsSelected" RelativeSource="{RelativeSource AncestorType=ListBoxItem}" />
                                                </MultiBinding>
                                            </ToggleButton.Visibility>
                                            <ToggleButton.RenderTransform>
                                                <RotateTransform x:Name="ChevronRotation" Angle="0" CenterX="10" CenterY="10"/>
                                            </ToggleButton.RenderTransform>
                                            <ToggleButton.Style>
                                                <Style TargetType="ToggleButton">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="ToggleButton">
                                                                <Border Background="{TemplateBinding Background}">
                                                                    <Viewbox Width="12" Height="12" Stretch="Uniform">
                                                                        <Canvas Width="12" Height="12">
                                                                            <Path Data="M2,5 L6,9 L10,5"
                                                                                  Stroke="White"
                                                                                  StrokeThickness="2"
                                                                                  StrokeStartLineCap="Round"
                                                                                  StrokeEndLineCap="Round"
                                                                                  StrokeLineJoin="Round" />
                                                                        </Canvas>
                                                                    </Viewbox>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Trigger.EnterActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                         To="180" Duration="0:0:0.2" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.EnterActions>
                                                            <Trigger.ExitActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                         To="0" Duration="0:0:0.2" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.ExitActions>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ToggleButton.Style>
                                        </ToggleButton>
                                    </Grid>
                                    
                                    <!-- Expandable file menu section -->
                                    <Border x:Name="FileMenuExpander" 
                                            Background="Transparent"
                                            BorderBrush="#33000000"
                                            BorderThickness="0,1,0,0"
                                            Margin="4,0,4,0"
                                            MaxHeight="0"
                                            Opacity="0">
                                        <Border.LayoutTransform>
                                            <ScaleTransform ScaleY="0" />
                                        </Border.LayoutTransform>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFileMenuExpanded}" Value="True">
                                                        <DataTrigger.EnterActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="500" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="1" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="1" Duration="0:0:0.35" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.EnterActions>
                                                        <DataTrigger.ExitActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="0" Duration="0:0:0.3" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.ExitActions>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Margin="4,4">
                                            <!-- Project dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="project">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <!-- For new projects: create AnythingLLM workspace and import -->
                                                <Button Command="{Binding NewProjectCommand}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        IsEnabled="{Binding IsAnythingLLMAvailable}">
                                                    <TextBlock Text="🆕 New Project" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding QuickImportCommand}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="⚡ Quick Import (Legacy)" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <!-- For existing projects: resume work -->
                                                <Button Command="{Binding OpenProjectCommand}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        IsEnabled="{Binding IsAnythingLLMAvailable}">
                                                    <TextBlock Text="📁 Open Project" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding SaveProjectCommand}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="💾 Save Project" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.CloseProjectCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="❌ Close Project" TextWrapping="Wrap" />
                                                </Button>
                                            </StackPanel>
                                            
                                            <!-- Requirements dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="requirements">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <Button Command="{Binding DataContext.ImportAdditionalCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="📥 Import Additional Requirements" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <!-- Analysis CollapsibleMenuItem -->
                                                <StackPanel>
                                                    <Button Background="{StaticResource Brush.Background.Menu}" 
                                                            BorderThickness="0"
                                                            Padding="8,6"
                                                            HorizontalAlignment="Stretch"
                                                            Cursor="Hand"
                                                            Click="AnalysisHeader_Click">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}" 
                                                                                    Padding="{TemplateBinding Padding}">
                                                                                <ContentPresenter/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="{StaticResource Brush.Button.Hover}"/>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="🔬 Analysis"
                                                                       Grid.Column="0"
                                                                       Foreground="{StaticResource Brush.Accent.Primary}"
                                                                       FontSize="13"
                                                                       FontWeight="Normal"
                                                                       VerticalAlignment="Center"
                                                                       Margin="0,0,8,0"/>
                                                            <TextBlock x:Name="AnalysisChevron"
                                                                       Grid.Column="1"
                                                                       Text="⯆"
                                                                       Foreground="{StaticResource Brush.Accent.Primary}"
                                                                       FontSize="12"
                                                                       VerticalAlignment="Center"
                                                                       RenderTransformOrigin="0.5,0.5">
                                                                <TextBlock.RenderTransform>
                                                                    <RotateTransform Angle="0"/>
                                                                </TextBlock.RenderTransform>
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsAnalysisMenuExpanded}" Value="True">
                                                                                <DataTrigger.EnterActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                                             To="180" Duration="0:0:0.2" />
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.EnterActions>
                                                                                <DataTrigger.ExitActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                                             To="0" Duration="0:0:0.2" />
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.ExitActions>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Grid>
                                                    </Button>
                                                    <!-- Analysis menu with proper animation like file menus -->
                                                    <Border x:Name="AnalysisMenuExpander" 
                                                            Background="Transparent"
                                                            BorderBrush="#33000000"
                                                            BorderThickness="0,1,0,0"
                                                            Margin="4,0,4,0"
                                                            MaxHeight="0"
                                                            Opacity="0">
                                                        <Border.LayoutTransform>
                                                            <ScaleTransform ScaleY="0" />
                                                        </Border.LayoutTransform>
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsAnalysisMenuExpanded}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                                     To="300" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                                     To="1" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                                     To="1" Duration="0:0:0.4" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                        <DataTrigger.ExitActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.ExitActions>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Margin="8">
                                                            <Button Command="{Binding DataContext.BatchAnalyzeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}">
                                                                <TextBlock Text="⚡ Analyze All Requirements" TextWrapping="Wrap" />
                                                            </Button>
                                                            <Button Command="{Binding DataContext.AnalyzeUnanalyzedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}">
                                                                <TextBlock Text="🔍 Analyze Unanalyzed" TextWrapping="Wrap" />
                                                            </Button>
                                                            <Button Command="{Binding DataContext.ReAnalyzeModifiedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}">
                                                                <TextBlock Text="🔄 Re-analyze Modified" TextWrapping="Wrap" />
                                                            </Button>
                                                            <Button Command="{Binding DataContext.PasteChatGptAnalysisCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}">
                                                                <TextBlock Text="📥 Paste ChatGPT Analysis" TextWrapping="Wrap" />
                                                            </Button>
                                                            <Button Command="{Binding DataContext.GenerateAnalysisCommandCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}">
                                                                <TextBlock Text="🔍 Generate Analysis Command" TextWrapping="Wrap" />
                                                            </Button>
                                                            <Button Command="{Binding DataContext.ExportForChatGptCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}">
                                                                <TextBlock Text="📝 Export for ChatGPT" TextWrapping="Wrap" />
                                                            </Button>
                                                        </StackPanel>
                                                    </Border>
                                                </StackPanel>
                                                
                                                <!-- Clarifying Questions CollapsibleMenuItem -->
                                                <StackPanel>
                                                    <Button Background="{StaticResource Brush.Background.Menu}" 
                                                            BorderThickness="0"
                                                            Padding="8,6"
                                                            HorizontalAlignment="Stretch"
                                                            Cursor="Hand"
                                                            Click="QuestionsHeader_Click">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}" 
                                                                                    Padding="{TemplateBinding Padding}">
                                                                                <ContentPresenter/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="{StaticResource Brush.Button.Hover}"/>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="❓ Clarifying Questions"
                                                                       Grid.Column="0"
                                                                       Foreground="{StaticResource Brush.Accent.Primary}"
                                                                       FontSize="13"
                                                                       FontWeight="Normal"
                                                                       VerticalAlignment="Center"
                                                                       Margin="0,0,8,0"/>
                                                            <TextBlock x:Name="QuestionsChevron"
                                                                       Grid.Column="1"
                                                                       Text="⯆"
                                                                       Foreground="{StaticResource Brush.Accent.Primary}"
                                                                       FontSize="12"
                                                                       VerticalAlignment="Center"
                                                                       RenderTransformOrigin="0.5,0.5">
                                                                <TextBlock.RenderTransform>
                                                                    <RotateTransform Angle="0"/>
                                                                </TextBlock.RenderTransform>
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsQuestionsMenuExpanded}" Value="True">
                                                                                <DataTrigger.EnterActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                                             To="180" Duration="0:0:0.2" />
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.EnterActions>
                                                                                <DataTrigger.ExitActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                                             To="0" Duration="0:0:0.2" />
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.ExitActions>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Grid>
                                                    </Button>
                                                    <!-- Questions menu with proper animation -->
                                                    <Border x:Name="QuestionsMenuExpander" 
                                                            Background="Transparent"
                                                            BorderBrush="#33000000"
                                                            BorderThickness="0,1,0,0"
                                                            Margin="4,0,4,0"
                                                            MaxHeight="0"
                                                            Opacity="0">
                                                        <Border.LayoutTransform>
                                                            <ScaleTransform ScaleY="0" />
                                                        </Border.LayoutTransform>
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsQuestionsMenuExpanded}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                                     To="200" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                                     To="1" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                                     To="1" Duration="0:0:0.4" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                        <DataTrigger.ExitActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.ExitActions>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Margin="8">
                                                            <Button Content="❓ Ask Questions" 
                                                                    Click="AskQuestions_Click"
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}"/>
                                                            <Button Content="📋 Paste from Clipboard" 
                                                                    Click="PasteFromClipboard_Click"
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}"/>
                                                            <Button Content="🔄 Regenerate Questions" 
                                                                    Click="RegenerateQuestions_Click"
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}"/>
                                                            <Button Content="⏭️ Skip Questions" 
                                                                    Click="SkipQuestions_Click"
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}"/>
                                                        </StackPanel>
                                                    </Border>
                                                </StackPanel>
                                                
                                                <!-- Verification Method Assumptions CollapsibleMenuItem -->
                                                <StackPanel>
                                                    <Button Background="{StaticResource Brush.Background.Menu}" 
                                                            BorderThickness="0"
                                                            Padding="8,6"
                                                            HorizontalAlignment="Stretch"
                                                            Cursor="Hand"
                                                            Click="AssumptionsHeader_Click">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}" 
                                                                                    Padding="{TemplateBinding Padding}">
                                                                                <ContentPresenter/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="{StaticResource Brush.Button.Hover}"/>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="🔧 Verification Method Assumptions"
                                                                       Grid.Column="0"
                                                                       Foreground="{StaticResource Brush.Accent.Primary}"
                                                                       FontSize="13"
                                                                       FontWeight="Normal"
                                                                       VerticalAlignment="Center"
                                                                       Margin="0,0,8,0"/>
                                                            <TextBlock x:Name="AssumptionsChevron"
                                                                       Grid.Column="1"
                                                                       Text="⯆"
                                                                       Foreground="{StaticResource Brush.Accent.Primary}"
                                                                       FontSize="12"
                                                                       VerticalAlignment="Center"
                                                                       RenderTransformOrigin="0.5,0.5">
                                                                <TextBlock.RenderTransform>
                                                                    <RotateTransform Angle="0"/>
                                                                </TextBlock.RenderTransform>
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsAssumptionsMenuExpanded}" Value="True">
                                                                                <DataTrigger.EnterActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                                             To="180" Duration="0:0:0.2" />
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.EnterActions>
                                                                                <DataTrigger.ExitActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                                             To="0" Duration="0:0:0.2" />
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.ExitActions>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Grid>
                                                    </Button>
                                                    <!-- Assumptions menu with proper animation -->
                                                    <Border x:Name="AssumptionsMenuExpander" 
                                                            Background="Transparent"
                                                            BorderBrush="#33000000"
                                                            BorderThickness="0,1,0,0"
                                                            Margin="4,0,4,0"
                                                            MaxHeight="0"
                                                            Opacity="0">
                                                        <Border.LayoutTransform>
                                                            <ScaleTransform ScaleY="0" />
                                                        </Border.LayoutTransform>
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsAssumptionsMenuExpanded}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                                     To="150" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                                     To="1" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                                     To="1" Duration="0:0:0.4" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                        <DataTrigger.ExitActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard>
                                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                                     To="0" Duration="0:0:0.4" />
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.ExitActions>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Margin="8">
                                                            <Button Content="🔄 Reset All Assumptions" 
                                                                    Click="ResetAssumptions_Click"
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}"/>
                                                            <Button Content="🧹 Clear Preset Filter" 
                                                                    Click="ClearPresetFilter_Click"
                                                                    Style="{StaticResource SideMenuPopupButtonStyle}"/>
                                                        </StackPanel>
                                                    </Border>
                                                </StackPanel>

                                            </StackPanel>
                                            
                                            <!-- LLM Learning dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="llm-learning">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <localControls:DropdownSectionHeader Icon="📚" Header="Learning Workflow" />

                                                <!-- Generate learning prompt button -->
                                                <Button Command="{Binding DataContext.GenerateLearningPromptCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Generate learning prompt and copy to clipboard for ChatGPT">
                                                    <TextBlock Text="📋 Generate Learning Prompt" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="🎓" Header="Advanced Training" />

                                                <!-- Setup LLM Workspace button -->
                                                <Button Command="{Binding DataContext.SetupLlmWorkspaceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Setup integrated LLM workspace for streamlined communication">
                                                    <TextBlock Text="🔧 Setup LLM Workspace" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="⚡" Header="Quick Commands" />

                                                <!-- Generate Test Case Command button -->
                                                <Button Command="{Binding DataContext.GenerateTestCaseCommandCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Generate 'GENERATE TEST CASES: [requirement]' command for current requirement">
                                                    <TextBlock Text="⚙️ Generate Test Case Command" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="📤" Header="Export Options" />

                                                <!-- Toggle to control auto-export for ChatGPT after import -->
                                                <Button Command="{Binding DataContext.ToggleAutoExportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="When enabled, automatically export requirements for ChatGPT analysis after importing.">
                                                    <DockPanel>
                                                        <TextBlock Text="Export for ChatGPT" Foreground="White" />
                                                        <TextBlock Text="✔"
                                                                   Foreground="LightBlue"
                                                                   FontWeight="Bold"
                                                                   Margin="6,0,0,0"
                                                                   DockPanel.Dock="Right"
                                                                   Visibility="{Binding DataContext.AutoExportForChatGpt, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVis}}" />
                                                    </DockPanel>
                                                </Button>
                                            </StackPanel>
                                            
                                            <!-- Test Case Generator dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="testcase-creation">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <Button Command="{Binding DataContext.ExportAllToJamaCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="Export to Jama…" TextWrapping="Wrap" />
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                            </ListBox.ItemTemplate>
                            <!-- Item container style: left 4px accent stripe for selection -->
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Padding" Value="0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                    <Setter Property="IsEnabled" Value="{Binding IsSelectable}"/>

                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Outer" Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="4" />
                                                            <ColumnDefinition Width="*" />
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Selection stripe -->
                                                        <Border x:Name="SelectionStripe" Grid.Column="0" Background="{DynamicResource HeaderAccentBrush}" Visibility="Collapsed" />

                                                        <ContentPresenter Grid.Column="1"
                                                      Content="{TemplateBinding Content}"
                                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                                      Margin="0"
                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                                    </Grid>
                                                </Border>

                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="SelectionStripe" Property="Visibility" Value="Visible"/>
                                                    </Trigger>

                                                    <Trigger Property="IsEnabled" Value="False">
                                                        <Setter Property="Opacity" Value="0.55"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                        </ListBox>
                    </StackPanel>
                </Border>

                <!-- Test Flow Generator group -->
                <ToggleButton x:Name="TestFlowGeneratorToggle"
                              Style="{StaticResource ActionToggleButton}"
                              HorizontalAlignment="Stretch"
                              Cursor="Hand"
                              Margin="0,6,0,0"
                              IsChecked="{Binding SelectedMenuSection, Converter={StaticResource SectionSelectedConverter}, ConverterParameter=TestFlow, Mode=TwoWay}">
                    <TextBlock Text="Test Flow Generator" FontSize="16" FontWeight="Normal" />
                </ToggleButton>

                <Border Margin="0,4,0,0" Padding="0" Background="Transparent" ClipToBounds="True">
                    <Border.LayoutTransform>
                        <ScaleTransform ScaleY="0" />
                    </Border.LayoutTransform>

                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Opacity" Value="0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TestFlowGeneratorToggle}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="1" Duration="0:0:0.20" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.14" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="0" Duration="0:0:0.16" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.12" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <StackPanel>
                        <!-- Test Flow Steps list -->
                        <ListBox ItemsSource="{Binding TestFlowSteps}"
                                 SelectedItem="{Binding SelectedStep, Mode=TwoWay}"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 SelectionMode="Single"
                                 Margin="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <Grid MinHeight="28" Background="Transparent">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Left: label + badge -->
                                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock x:Name="TitleText"
                                                           Text="{Binding DisplayName}"
                                                           Foreground="#CCCCCC"
                                                           VerticalAlignment="Center"
                                                           FontSize="13"
                                                           FontWeight="Normal"/>
                                                <TextBlock Text="{Binding Badge}"
                                                           Foreground="DarkOrange"
                                                           Margin="8,0,0,0"
                                                           VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Right: Chevron toggle button -->
                                        <ToggleButton Grid.Column="1" 
                                                      IsChecked="{Binding IsFileMenuExpanded, Mode=TwoWay}"
                                                      Width="20" Height="20"
                                                      Margin="0,0,4,0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Center"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      Cursor="Hand">
                                            <ToggleButton.Visibility>
                                                <MultiBinding Converter="{StaticResource AllTrueToVisibilityConverter}">
                                                    <Binding Path="HasFileMenu" />
                                                    <Binding Path="IsSelected" RelativeSource="{RelativeSource AncestorType=ListBoxItem}" />
                                                </MultiBinding>
                                            </ToggleButton.Visibility>
                                            <ToggleButton.RenderTransform>
                                                <RotateTransform x:Name="ChevronRotation" Angle="0" CenterX="10" CenterY="10"/>
                                            </ToggleButton.RenderTransform>
                                            <ToggleButton.Style>
                                                <Style TargetType="ToggleButton">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="ToggleButton">
                                                                <Border Background="{TemplateBinding Background}">
                                                                    <Viewbox Width="12" Height="12" Stretch="Uniform">
                                                                        <Canvas Width="12" Height="12">
                                                                            <Path Data="M2,5 L6,9 L10,5"
                                                                                  Stroke="White"
                                                                                  StrokeThickness="2"
                                                                                  StrokeStartLineCap="Round"
                                                                                  StrokeEndLineCap="Round"
                                                                                  StrokeLineJoin="Round" />
                                                                        </Canvas>
                                                                    </Viewbox>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Trigger.EnterActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                         To="180" Duration="0:0:0.2" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.EnterActions>
                                                            <Trigger.ExitActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                         To="0" Duration="0:0:0.2" />
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.ExitActions>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ToggleButton.Style>
                                        </ToggleButton>
                                    </Grid>
                                    
                                    <!-- Expandable file menu section for Test Flow -->
                                    <Border x:Name="TestFlowMenuExpander" 
                                            Background="Transparent"
                                            BorderBrush="#33000000"
                                            BorderThickness="0,1,0,0"
                                            Margin="4,0,4,0"
                                            MaxHeight="0"
                                            Opacity="0">
                                        <Border.LayoutTransform>
                                            <ScaleTransform ScaleY="0" />
                                        </Border.LayoutTransform>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFileMenuExpanded}" Value="True">
                                                        <DataTrigger.EnterActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="500" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="1" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="1" Duration="0:0:0.35" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.EnterActions>
                                                        <DataTrigger.ExitActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="0" Duration="0:0:0.3" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.ExitActions>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Margin="4,4">
                                            <!-- Test Flow specific dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="test-flow">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <localControls:DropdownSectionHeader Icon="🔄" Header="Flow Operations" />
                                                
                                                <Button Command="{Binding DataContext.CreateNewFlowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="🆕 Create New Flow" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.ValidateFlowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="✅ Validate Flow" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.ExportFlowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="📤 Export Flow" TextWrapping="Wrap" />
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <!-- Static Testing dropdown item -->
                    <Grid MinHeight="28" Background="Transparent" Margin="0,4,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Left: Testing label -->
                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6">
                            <TextBlock Text="Testing"
                                       Foreground="#CCCCCC"
                                       VerticalAlignment="Center"
                                       FontSize="13"
                                       FontWeight="Normal"/>
                        </StackPanel>

                        <!-- Right: Chevron toggle button -->
                        <ToggleButton x:Name="TestingDropdownToggle"
                                      Grid.Column="1" 
                                      Width="20" Height="20"
                                      Margin="0,0,4,0"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      Cursor="Hand">
                            <ToggleButton.RenderTransform>
                                <RotateTransform x:Name="TestingChevronRotation" Angle="0" CenterX="10" CenterY="10"/>
                            </ToggleButton.RenderTransform>
                            <ToggleButton.Style>
                                <Style TargetType="ToggleButton">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}">
                                                    <Viewbox Width="12" Height="12" Stretch="Uniform">
                                                        <Canvas Width="12" Height="12">
                                                            <Path Data="M2,5 L6,9 L10,5"
                                                                  Stroke="White"
                                                                  StrokeThickness="2"
                                                                  StrokeStartLineCap="Round"
                                                                  StrokeEndLineCap="Round"
                                                                  StrokeLineJoin="Round" />
                                                        </Canvas>
                                                    </Viewbox>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsChecked" Value="True">
                                            <Trigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                         To="180" Duration="0:0:0.2" />
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.EnterActions>
                                            <Trigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                         To="0" Duration="0:0:0.2" />
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.ExitActions>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ToggleButton.Style>
                        </ToggleButton>
                    </Grid>
                    
                    <!-- Testing dropdown content -->
                    <Border x:Name="TestingMenuExpander" 
                            Background="Transparent"
                            BorderBrush="#33000000"
                            BorderThickness="0,1,0,0"
                            Margin="4,0,4,0"
                            MaxHeight="0"
                            Opacity="0">
                        <Border.LayoutTransform>
                            <ScaleTransform ScaleY="0" />
                        </Border.LayoutTransform>
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsChecked, ElementName=TestingDropdownToggle}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                     To="200" Duration="0:0:0.4" />
                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                     To="1" Duration="0:0:0.4" />
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                     To="1" Duration="0:0:0.35" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                     To="0" Duration="0:0:0.35" />
                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                     To="0" Duration="0:0:0.35" />
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                     To="0" Duration="0:0:0.3" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <StackPanel Margin="4,4">
                            <Button Style="{StaticResource SideMenuPopupButtonStyle}">
                                <TextBlock Text="🧪 Test Option 1" TextWrapping="Wrap" />
                            </Button>
                            <Button Style="{StaticResource SideMenuPopupButtonStyle}">
                                <TextBlock Text="🔬 Test Option 2" TextWrapping="Wrap" />
                            </Button>
                        </StackPanel>
                    </Border>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <TextBlock Grid.Row="1"
                   VerticalAlignment="Bottom"
                   Text="{Binding SapStatus}"
                   HorizontalAlignment="Center"
                   Foreground="#CCCCCC"
                   Style="{StaticResource MenuHeaderTheme}"/>
        </Grid>
    </Border>
</UserControl>