<UserControl x:Class="TestCaseEditorApp.MVVM.Views.SideMenuView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:conv="clr-namespace:TestCaseEditorApp.Converters"
             xmlns:controls="clr-namespace:TestCaseEditorApp.Controls"
             xmlns:localControls="clr-namespace:TestCaseEditorApp.MVVM.Controls"
             xmlns:dataDrivenMenu="clr-namespace:TestCaseEditorApp.MVVM.Controls.DataDrivenMenu"
             xmlns:vm="clr-namespace:TestCaseEditorApp.MVVM.ViewModels" d:DataContext="{d:DesignInstance Type=vm:MainViewModel, IsDesignTimeCreatable=False}"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="200">

    

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- Include MenuAction templates for ContentPresenter -->
                <ResourceDictionary Source="../Controls/DataDrivenMenu/MenuContentTemplates.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <!-- Local converters -->
            <conv:SectionSelectedConverter x:Key="SectionSelectedConverter" />
            <conv:AllTrueToVisibilityConverter x:Key="AllTrueToVisibilityConverter" />
            <BooleanToVisibilityConverter x:Key="BoolToVis" />
            <conv:BoolToAngleConverter x:Key="BoolToAngleConverter" />
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Background="#2B2B2B" CornerRadius="4" Margin="0" BorderBrush="{StaticResource Brush.Accent.Primary}" BorderThickness="2">
        <Grid Background="{StaticResource Brush.Background.Menu}" Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Visible">
                <ScrollViewer.Resources>
                    <Style TargetType="ScrollBar" BasedOn="{StaticResource CustomScrollBarStyle}" />
                </ScrollViewer.Resources>
                <StackPanel>

                <!-- Test Case Generator header -->
                <ToggleButton x:Name="TestCaseGeneratorToggle"
                              Style="{StaticResource ActionToggleButton}"
                              HorizontalAlignment="Stretch"
                              Cursor="Hand"
                              Margin="0,6,0,0"
                              IsChecked="{Binding SelectedMenuSection, Converter={StaticResource SectionSelectedConverter}, ConverterParameter=TestCase, Mode=TwoWay}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Test Case Generator" FontSize="16" FontWeight="Normal" HorizontalAlignment="Left" />
                        <!-- Chevron for main header -->
                        <localControls:AnimatedChevron Grid.Column="1" 
                                                       IsExpanded="{Binding IsChecked, ElementName=TestCaseGeneratorToggle}"/>
                    </Grid>
                </ToggleButton>

                <!-- Animated expanded area -->
                <Border Margin="0,4,0,0" Padding="0" Background="Transparent" ClipToBounds="True">
                    <Border.LayoutTransform>
                        <ScaleTransform ScaleY="0" />
                    </Border.LayoutTransform>
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Opacity" Value="0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TestCaseGeneratorToggle}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="1" Duration="0:0:0.35" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.25" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="0" Duration="0:0:0.30" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.20" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <!-- Cleaned ListBox / item template fragment for the Steps list -->
                    <StackPanel>

                        <!-- Steps list -->
                        <ListBox x:Name="StepsListBox"
             ItemsSource="{Binding TestCaseGeneratorSteps}"
             SelectedItem="{Binding SelectedStep, Mode=TwoWay}"
             Background="Transparent"
             BorderThickness="0"
             SelectionMode="Single"
             Margin="0"
             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
             d:ItemsSource="{d:SampleData ItemCount=5}"
             SelectionChanged="StepsListBox_SelectionChanged">
                            <!-- Fixed ListBox.ItemTemplate fragment -->
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <Grid MinHeight="28" Background="Transparent" 
                                              MouseLeftButtonUp="MenuItemGrid_Click">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                        <!-- Left: label + badge -->
                                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock x:Name="TitleText"
                     Text="{Binding DisplayName}"
                     Foreground="#CCCCCC"
                     VerticalAlignment="Center"
                     FontSize="13"
                     FontWeight="Normal"/>
                                                <TextBlock Text="{Binding Badge}"
                     Foreground="DarkOrange"
                     Margin="8,0,0,0"
                     VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Right: Chevron toggle button -->
                                        <ToggleButton Grid.Column="1" 
                                                      IsChecked="{Binding IsFileMenuExpanded, Mode=TwoWay}"
                                                      Width="20" Height="20"
                                                      Margin="0,0,4,0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Center"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      Cursor="Hand"
                                                      Opacity="0">
                                            <ToggleButton.Visibility>
                                                <Binding Path="HasFileMenu" Converter="{StaticResource BoolToVis}" />
                                            </ToggleButton.Visibility>
                                        </ToggleButton>
                                        
                                        <!-- Visible chevron overlay -->
                                        <localControls:AnimatedChevron Grid.Column="1"
                                                                       IsExpanded="{Binding IsFileMenuExpanded}"
                                                                       ChevronSize="12"
                                                                       ChevronMargin="0,0,4,0"
                                                                       VerticalAlignment="Center"
                                                                       HorizontalAlignment="Center"
                                                                       IsHitTestVisible="False">
                                            <localControls:AnimatedChevron.Visibility>
                                                <Binding Path="HasFileMenu" Converter="{StaticResource BoolToVis}" />
                                            </localControls:AnimatedChevron.Visibility>
                                        </localControls:AnimatedChevron>
                                    </Grid>
                                    
                                    <!-- Expandable file menu section -->
                                    <Border x:Name="FileMenuExpander" 
                                            Background="Transparent"
                                            BorderBrush="#33000000"
                                            BorderThickness="0,1,0,0"
                                            Margin="4,0,4,0"
                                            MaxHeight="0"
                                            Opacity="0">
                                        <Border.LayoutTransform>
                                            <ScaleTransform ScaleY="0" />
                                        </Border.LayoutTransform>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFileMenuExpanded}" Value="True">
                                                        <DataTrigger.EnterActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="500" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="1" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="1" Duration="0:0:0.35" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.EnterActions>
                                                        <DataTrigger.ExitActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="0" Duration="0:0:0.3" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.ExitActions>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Margin="4,4">
                                            <!-- Project dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="project">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <!-- For new projects: create AnythingLLM workspace and import -->
                                                <Button Command="{Binding DataContext.NewProjectCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ†• New Project" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.QuickImportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="âš¡ Quick Import (Legacy)" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <!-- For existing projects: resume work -->
                                                <Button Command="{Binding DataContext.OpenProjectCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ“ Open Project" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.SaveProjectCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ’¾ Save Project" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.CloseProjectCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="âŒ Close Project" TextWrapping="Wrap" />
                                                </Button>
                                            </StackPanel>
                                            
                                            <!-- Requirements dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="requirements">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <Button Command="{Binding DataContext.ImportAdditionalCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ“¥ Import Additional Requirements" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.BatchAnalyzeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="âš¡ Analyze All Requirements" TextWrapping="Wrap" />
                                                </Button>


                                            </StackPanel>
                                            
                                            <!-- LLM Learning dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="llm-learning">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <Button Command="{Binding DataContext.AnalyzeUnanalyzedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ” Analyze Unanalyzed" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.ReAnalyzeModifiedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ”„ Re-analyze Modified" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="ðŸ“š" Header="Learning Workflow" />

                                                <!-- Generate learning prompt button -->
                                                <Button Command="{Binding DataContext.GenerateLearningPromptCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Generate learning prompt and copy to clipboard for ChatGPT">
                                                    <TextBlock Text="ðŸ“‹ Generate Learning Prompt" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.PasteChatGptAnalysisCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Paste and import ChatGPT analysis results from clipboard">
                                                    <TextBlock Text="ðŸ“¥ Paste ChatGPT Analysis" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="ðŸŽ“" Header="Advanced Training" />

                                                <!-- Setup LLM Workspace button -->
                                                <Button Command="{Binding DataContext.SetupLlmWorkspaceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Setup integrated LLM workspace for streamlined communication">
                                                    <TextBlock Text="ðŸ”§ Setup LLM Workspace" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="âš¡" Header="Quick Commands" />

                                                <!-- Generate Analysis Command button -->
                                                <Button Command="{Binding DataContext.GenerateAnalysisCommandCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Generate 'ANALYZE: [requirement]' command for current requirement">
                                                    <TextBlock Text="ðŸ” Generate Analysis Command" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <!-- Generate Test Case Command button -->
                                                <Button Command="{Binding DataContext.GenerateTestCaseCommandCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Generate 'GENERATE TEST CASES: [requirement]' command for current requirement">
                                                    <TextBlock Text="âš™ï¸ Generate Test Case Command" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <localControls:DropdownSectionHeader Icon="ðŸ“¤" Header="Export Options" />

                                                <!-- Toggle to control auto-export for ChatGPT after import -->
                                                <Button Command="{Binding DataContext.ToggleAutoExportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="When enabled, automatically export requirements for ChatGPT analysis after importing.">
                                                    <DockPanel>
                                                        <TextBlock Text="Export for ChatGPT" Foreground="White" />
                                                        <TextBlock Text="âœ”"
                                                                   Foreground="LightBlue"
                                                                   FontWeight="Bold"
                                                                   Margin="6,0,0,0"
                                                                   DockPanel.Dock="Right"
                                                                   Visibility="{Binding DataContext.AutoExportForChatGpt, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVis}}" />
                                                    </DockPanel>
                                                </Button>

                                                <!-- Open ChatGPT Export File button -->
                                                <Button Command="{Binding DataContext.OpenChatGptExportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        Style="{StaticResource SideMenuPopupButtonStyle}"
                                                        ToolTip="Open the most recent ChatGPT export file in Notepad">
                                                    <DockPanel>
                                                        <TextBlock Text="ðŸ“" Foreground="White" Margin="0,0,4,0" />
                                                        <TextBlock Text="Open Export" Foreground="White" />
                                                    </DockPanel>
                                                </Button>
                                            </StackPanel>
                                            
                                            <!-- Test Case Generator dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="testcase-creation">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <Button Command="{Binding DataContext.ExportAllToJamaCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="Export to Jamaâ€¦" TextWrapping="Wrap" />
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                            </ListBox.ItemTemplate>
                            <!-- Item container style: left 4px accent stripe for selection -->
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Padding" Value="0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                    <Setter Property="IsEnabled" Value="{Binding IsSelectable}"/>

                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Outer" Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="4" />
                                                            <ColumnDefinition Width="*" />
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Selection stripe -->
                                                        <Border x:Name="SelectionStripe" Grid.Column="0" Background="{DynamicResource HeaderAccentBrush}" Visibility="Collapsed" />

                                                        <ContentPresenter Grid.Column="1"
                                                      Content="{TemplateBinding Content}"
                                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                                      Margin="0"
                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                                    </Grid>
                                                </Border>

                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="SelectionStripe" Property="Visibility" Value="Visible"/>
                                                    </Trigger>

                                                    <Trigger Property="IsEnabled" Value="False">
                                                        <Setter Property="Opacity" Value="0.55"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                        </ListBox>
                    </StackPanel>
                </Border>

                <!-- Test Flow Generator group -->
                <ToggleButton x:Name="TestFlowGeneratorToggle"
                              Style="{StaticResource ActionToggleButton}"
                              HorizontalAlignment="Stretch"
                              Cursor="Hand"
                              Margin="0,6,0,0"
                              IsChecked="{Binding SelectedMenuSection, Converter={StaticResource SectionSelectedConverter}, ConverterParameter=TestFlow, Mode=TwoWay}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Test Flow Generator" FontSize="16" FontWeight="Normal" HorizontalAlignment="Left" />
                        <!-- Chevron for main header -->
                        <localControls:AnimatedChevron Grid.Column="1" 
                                                       IsExpanded="{Binding IsChecked, ElementName=TestFlowGeneratorToggle}"/>
                    </Grid>
                </ToggleButton>

                <Border Margin="0,4,0,0" Padding="0" Background="Transparent" ClipToBounds="True">
                    <Border.LayoutTransform>
                        <ScaleTransform ScaleY="0" />
                    </Border.LayoutTransform>

                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Opacity" Value="0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TestFlowGeneratorToggle}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="1" Duration="0:0:0.35" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.25" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" To="0" Duration="0:0:0.30" AccelerationRatio="0.15" DecelerationRatio="0.85"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.20" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <StackPanel>
                        <!-- Test Flow Steps list -->
                        <ListBox ItemsSource="{Binding TestFlowSteps}"
                                 SelectedItem="{Binding SelectedStep, Mode=TwoWay}"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 SelectionMode="Single"
                                 Margin="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <Grid MinHeight="28" Background="Transparent"
                                          MouseLeftButtonUp="MenuItemGrid_Click">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Left: label + badge -->
                                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock x:Name="TitleText"
                                                           Text="{Binding DisplayName}"
                                                           Foreground="#CCCCCC"
                                                           VerticalAlignment="Center"
                                                           FontSize="13"
                                                           FontWeight="Normal"/>
                                                <TextBlock Text="{Binding Badge}"
                                                           Foreground="DarkOrange"
                                                           Margin="8,0,0,0"
                                                           VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Right: Chevron toggle button -->
                                        <ToggleButton Grid.Column="1" 
                                                      IsChecked="{Binding IsFileMenuExpanded, Mode=TwoWay}"
                                                      Width="20" Height="20"
                                                      Margin="0,0,4,0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Center"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      Cursor="Hand"
                                                      Template="{x:Null}">
                                            <ToggleButton.Visibility>
                                                <Binding Path="HasFileMenu" Converter="{StaticResource BoolToVis}" />
                                            </ToggleButton.Visibility>
                                            
                                            <localControls:AnimatedChevron IsExpanded="{Binding IsFileMenuExpanded}"
                                                                           ChevronSymbol="â–¼"
                                                                           ChevronSize="12"
                                                                           ChevronMargin="0"/>
                                        </ToggleButton>
                                    </Grid>
                                    
                                    <!-- Expandable file menu section for Test Flow -->
                                    <Border x:Name="TestFlowMenuExpander" 
                                            Background="Transparent"
                                            BorderBrush="#33000000"
                                            BorderThickness="0,1,0,0"
                                            Margin="4,0,4,0"
                                            MaxHeight="0"
                                            Opacity="0">
                                        <Border.LayoutTransform>
                                            <ScaleTransform ScaleY="0" />
                                        </Border.LayoutTransform>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFileMenuExpanded}" Value="True">
                                                        <DataTrigger.EnterActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="500" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="1" Duration="0:0:0.4" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="1" Duration="0:0:0.35" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.EnterActions>
                                                        <DataTrigger.ExitActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                                     To="0" Duration="0:0:0.35" />
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="0" Duration="0:0:0.3" />
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.ExitActions>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Margin="4,4">
                                            <!-- Test Flow specific dropdown items -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Id}" Value="test-flow">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                
                                                <localControls:DropdownSectionHeader Icon="ðŸ”„" Header="Flow Operations" />
                                                
                                                <Button Command="{Binding DataContext.CreateNewFlowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ†• Create New Flow" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.ValidateFlowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="âœ… Validate Flow" TextWrapping="Wrap" />
                                                </Button>
                                                
                                                <Button Command="{Binding DataContext.ExportFlowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        Style="{StaticResource SideMenuPopupButtonStyle}">
                                                    <TextBlock Text="ðŸ“¤ Export Flow" TextWrapping="Wrap" />
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <!-- Static Testing dropdown item -->
                    <Grid MinHeight="28" Background="Transparent" Margin="0,4,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Left: Testing label -->
                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Margin="8,6,0,6">
                            <TextBlock Text="Testing"
                                       Foreground="#CCCCCC"
                                       VerticalAlignment="Center"
                                       FontSize="13"
                                       FontWeight="Normal"/>
                        </StackPanel>

                        <!-- Right: Chevron toggle button -->
                        <ToggleButton x:Name="TestingDropdownToggle"
                                      Grid.Column="1" 
                                      Width="20" Height="20"
                                      Margin="0,0,4,0"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      Cursor="Hand">
                            <ToggleButton.RenderTransform>
                                <RotateTransform x:Name="TestingChevronRotation" Angle="0" CenterX="10" CenterY="10"/>
                            </ToggleButton.RenderTransform>
                            <ToggleButton.Style>
                                <Style TargetType="ToggleButton">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}">
                                                    <Viewbox Width="12" Height="12" Stretch="Uniform">
                                                        <Canvas Width="12" Height="12">
                                                            <Path Data="M2,5 L6,9 L10,5"
                                                                  Stroke="White"
                                                                  StrokeThickness="2"
                                                                  StrokeStartLineCap="Round"
                                                                  StrokeEndLineCap="Round"
                                                                  StrokeLineJoin="Round" />
                                                        </Canvas>
                                                    </Viewbox>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsChecked" Value="True">
                                            <Trigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                         To="180" Duration="0:0:0.2" />
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.EnterActions>
                                            <Trigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                         To="0" Duration="0:0:0.2" />
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.ExitActions>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ToggleButton.Style>
                        </ToggleButton>
                    </Grid>
                    
                    <!-- Testing dropdown content -->
                    <Border x:Name="TestingMenuExpander" 
                            Background="Transparent"
                            BorderBrush="#33000000"
                            BorderThickness="0,1,0,0"
                            Margin="4,0,4,0"
                            MaxHeight="0"
                            Opacity="0">
                        <Border.LayoutTransform>
                            <ScaleTransform ScaleY="0" />
                        </Border.LayoutTransform>
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsChecked, ElementName=TestingDropdownToggle}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                     To="200" Duration="0:0:0.4" />
                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                     To="1" Duration="0:0:0.4" />
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                     To="1" Duration="0:0:0.35" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                     To="0" Duration="0:0:0.35" />
                                                    <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY" 
                                                                     To="0" Duration="0:0:0.35" />
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                     To="0" Duration="0:0:0.3" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <StackPanel Margin="4,4">
                            <Button Style="{StaticResource SideMenuPopupButtonStyle}">
                                <TextBlock Text="ðŸ§ª Test Option 1" TextWrapping="Wrap" />
                            </Button>
                            <Button Style="{StaticResource SideMenuPopupButtonStyle}">
                                <TextBlock Text="ðŸ”¬ Test Option 2" TextWrapping="Wrap" />
                            </Button>
                        </StackPanel>
                    </Border>
                    </StackPanel>
                </Border>


                <!-- =============================== -->
                <!-- DATA-DRIVEN MENU TEST SECTION -->
                <!-- =============================== -->
                <Border Background="{StaticResource Brush.Background.Menu}" 
                        BorderBrush="{DynamicResource HeaderAccentBrush}" 
                        BorderThickness="2" 
                        CornerRadius="4" 
                        Margin="4,8,4,0">
                    <StackPanel Margin="8">
                        <!-- Data-driven menu with scrollbar to match original menu -->
                        <ScrollViewer VerticalScrollBarVisibility="Visible"
                                     HorizontalScrollBarVisibility="Disabled"
                                     MaxHeight="400">
                            <ScrollViewer.Resources>
                                <Style TargetType="ScrollBar" BasedOn="{StaticResource CustomScrollBarStyle}" />
                            </ScrollViewer.Resources>
                            <ItemsControl ItemsSource="{Binding TestCaseGeneratorMenuSection.Items}"
                                         Margin="0,4,0,0">
                                <ItemsControl.Resources>
                                    <ResourceDictionary>
                                        <ResourceDictionary.MergedDictionaries>
                                            <ResourceDictionary Source="/MVVM/Controls/DataDrivenMenu/MenuContentTemplates.xaml"/>
                                        </ResourceDictionary.MergedDictionaries>
                                    </ResourceDictionary>
                                </ItemsControl.Resources>
                                
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Vertical"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
                </Border>

                <TextBlock Grid.Row="1"
                           VerticalAlignment="Bottom"
                           Text="{Binding SapStatus}"
                           HorizontalAlignment="Center"
                           Foreground="#CCCCCC"
                           Style="{StaticResource MenuHeaderTheme}"/>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Border>
</UserControl>

