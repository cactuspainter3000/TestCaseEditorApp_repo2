<UserControl x:Class="TestCaseEditorApp.MVVM.Domains.Requirements.Views.Requirements_AnalysisControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:TestCaseEditorApp.MVVM.Domains.Requirements.ViewModels"
             xmlns:converters="clr-namespace:TestCaseEditorApp.Converters"
             xmlns:tcgConverters="clr-namespace:TestCaseEditorApp.MVVM.Domains.TestCaseGeneration.Converters"
             DataContext="{Binding RequirementAnalysisVM}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibilityConverter" />
        <converters:StringNotEmptyToVisibilityConverter x:Key="StringNotEmptyToVisibilityConverter" />
        <converters:StringEmptyToVisibilityConverter x:Key="StringEmptyToVisibilityConverter" />
        <tcgConverters:FixTextHighlightConverter x:Key="FixTextHighlightConverter" />
        <tcgConverters:BracketHighlightConverter x:Key="BracketHighlightConverter" />
        <converters:BoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" Invert="True" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- No Analysis State - Show Analyze Now button -->
        <Grid Grid.Row="0"
              Visibility="{Binding HasNoAnalysis, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center"
                        Margin="0,60">
                <TextBlock Text="Ready to analyze your requirement" 
                           FontSize="16" 
                           Foreground="#CCCCCC" 
                           HorizontalAlignment="Center"
                           Margin="0,0,0,24"/>
                
                <!-- Analyze Now Button -->
                <Button Command="{Binding AnalyzeNowCommand}"
                        Content="Analyze Now"
                        HorizontalAlignment="Center"
                        Padding="24,12"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Style="{StaticResource PillActionButtonStyle}"/>
            </StackPanel>
        </Grid>
        
        <!-- Analysis Results State -->
        <ScrollViewer Grid.Row="0"
                      VerticalScrollBarVisibility="Auto" 
                      HorizontalScrollBarVisibility="Disabled"
                      Padding="12"
                      Visibility="{Binding HasAnalysis, Converter={StaticResource BoolToVisibilityConverter}}">
            
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Header Section -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0"
                                   Text="Requirement Quality Analysis" 
                                   Style="{StaticResource Text.H2}"
                                   Margin="0,0,0,4"/>
                    </Grid>
                    
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0"
                                   Text="Original Quality Score  " 
                                   Style="{StaticResource Text.Caption}"/>
                        <TextBlock Grid.Column="1"
                                   Text="{Binding QualityScore}" 
                                   Style="{StaticResource Text.Caption}"
                                   Foreground="{DynamicResource AccentBrush}"
                                   FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="2"
                                   Text="/10" 
                                   Style="{StaticResource Text.Caption}"/>
                    </Grid>
                    
                    <TextBlock Grid.Row="2"
                               Text="{Binding AnalysisTimestamp}" 
                               Style="{StaticResource Text.Caption}"
                               Margin="0,2,0,0"/>
                </Grid>
                
                <!-- AI Re-write Section -->
                <Border Grid.Row="1"
                        Background="{DynamicResource MenuBackground}"
                        Padding="12"
                        Margin="0,0,0,12"
                        CornerRadius="4"
                        Visibility="{Binding HasImprovedRequirement, Converter={StaticResource BoolToVisibilityConverter}}">
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Header with Edit button -->
                        <Grid Grid.Row="0" 
                              Margin="0,0,0,8"
                              Visibility="{Binding IsEditingRequirement, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0"
                                       Text="ðŸ“ AI Re-write"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="#BBBBBB"
                                       VerticalAlignment="Center"/>
                            
                            <Button Grid.Column="1"
                                    Content="Edit"
                                    Command="{Binding EditRequirementCommand}"
                                    Style="{StaticResource ActionButton}"
                                    VerticalAlignment="Top"
                                    Margin="8,0,0,0"/>
                        </Grid>
                        
                        <!-- Read-only content -->
                        <Border Grid.Row="1"
                                Background="Transparent"
                                BorderBrush="#444444"
                                BorderThickness="0,0,0,1"
                                Padding="0,8,0,16"
                                Visibility="{Binding IsEditingRequirement, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                            <TextBlock Text="{Binding ImprovedRequirement}" 
                                       TextWrapping="Wrap"
                                       FontSize="13"
                                       Foreground="#D0D0D0"
                                       LineHeight="18"/>
                        </Border>
                        
                        <!-- Edit mode -->
                        <Grid Grid.Row="2"
                              Margin="0,8,0,0"
                              Visibility="{Binding IsEditingRequirement, Converter={StaticResource BoolToVisibilityConverter}}">
                            
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBox Grid.Row="0"
                                         Text="{Binding EditingRequirementText, UpdateSourceTrigger=PropertyChanged}"
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True"
                                         MinHeight="100"
                                         MaxHeight="300"
                                         FontSize="13"
                                         Foreground="#D0D0D0"
                                         Background="#1E1E1E"
                                         BorderBrush="#444444"
                                         BorderThickness="1"
                                         Padding="8"
                                         VerticalScrollBarVisibility="Auto"
                                         Margin="0,0,0,8"/>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Button Grid.Column="1"
                                            Content="{Binding CopyAnalysisButtonText}"
                                            Command="{Binding CopyAnalysisPromptCommand}"
                                            Style="{StaticResource ActionButton}"
                                            Margin="0,0,8,0"
                                            Visibility="{Binding ShouldHideCopyButton, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                    <Button Grid.Column="2"
                                            Content="Update"
                                            Command="{Binding SaveRequirementCommand}"
                                            Style="{StaticResource ActionButton}"
                                            Margin="0,0,8,0"/>
                                    <Button Grid.Column="3"
                                            Content="Cancel"
                                            Command="{Binding CancelEditRequirementCommand}"
                                            Style="{StaticResource ActionButton}"/>
                                </Grid>
                            </Grid>
                        </Grid>
                    </Grid>
                </Border>
                
                <!-- Issues Section -->
                <Border Grid.Row="2"
                        Background="{DynamicResource MenuBackground}"
                        Padding="12"
                        Margin="0,0,0,12"
                        CornerRadius="4"
                        Visibility="{Binding HasIssues, Converter={StaticResource BoolToVisibilityConverter}}">
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0"
                                   Text="Issues Identified" 
                                   Style="{StaticResource Text.H3}"
                                   Margin="0,0,0,8"/>
                        
                        <ItemsControl Grid.Row="1" ItemsSource="{Binding Issues}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource ControlBackground}"
                                            Padding="12"
                                            Margin="0,0,0,8"
                                            CornerRadius="4">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <Grid Grid.Row="0" Margin="0,0,0,6">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Category}" 
                                                           FontWeight="SemiBold"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource AccentBrush}"
                                                           VerticalAlignment="Center"/>
                                                
                                                <Border Grid.Column="1"
                                                        Padding="6,2"
                                                        CornerRadius="3">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Background" Value="#5C6B73"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Severity}" Value="High">
                                                                    <Setter Property="Background" Value="#D32F2F"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Severity}" Value="Medium">
                                                                    <Setter Property="Background" Value="#F57C00"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Severity}" Value="Low">
                                                                    <Setter Property="Background" Value="#5C6B73"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding Severity}" 
                                                               FontSize="10" 
                                                               Foreground="White"
                                                               FontWeight="SemiBold"/>
                                                </Border>
                                            </Grid>
                                            
                                            <ContentPresenter Grid.Row="1" Content="{Binding ., Converter={StaticResource FixTextHighlightConverter}}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>
                
                <!-- Recommendations Section -->
                <Border Grid.Row="3"
                        Background="{DynamicResource MenuBackground}"
                        Padding="12"
                        Margin="0,0,0,12"
                        CornerRadius="4"
                        Visibility="{Binding HasRecommendations, Converter={StaticResource BoolToVisibilityConverter}}">
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0"
                                   Text="Recommendations" 
                                   Style="{StaticResource Text.H3}"
                                   Margin="0,0,0,8"/>
                        
                        <ItemsControl Grid.Row="1" ItemsSource="{Binding Recommendations}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource ControlBackground}"
                                            Padding="12"
                                            Margin="0,0,0,8"
                                            CornerRadius="4">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0"
                                                       Text="{Binding Category}" 
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource AccentBrush}"
                                                       Margin="0,0,0,6"/>
                                            
                                            <ContentPresenter Grid.Row="1" Content="{Binding ., Converter={StaticResource BracketHighlightConverter}}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>
                
                <!-- Additional Feedback Section -->
                <Border Grid.Row="4"
                        Background="{DynamicResource MenuBackground}"
                        Padding="12"
                        CornerRadius="4"
                        Visibility="{Binding HasFreeformFeedback, Converter={StaticResource BoolToVisibilityConverter}}">
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0"
                                   Text="Additional Feedback" 
                                   Style="{StaticResource Text.H3}"
                                   Margin="0,0,0,8"/>
                        
                        <TextBlock Grid.Row="1"
                                   Text="{Binding FreeformFeedback}" 
                                   TextWrapping="Wrap"
                                   FontSize="12"
                                   Foreground="#CCCCCC"
                                   LineHeight="18"/>
                    </Grid>
                </Border>
                
            </Grid>
        </ScrollViewer>
        
        <!-- Error message at bottom -->
        <Grid Grid.Row="1"
              Visibility="{Binding AnalysisStatusMessage, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"
              Margin="12">
            <TextBlock Text="{Binding AnalysisStatusMessage}" 
                       FontSize="14" 
                       Foreground="#CC6666" 
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       MaxWidth="400"
                       TextAlignment="Center"
                       Margin="0,10,0,10"/>
        </Grid>
    </Grid>

</UserControl>
