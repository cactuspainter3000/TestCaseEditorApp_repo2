<UserControl x:Class="TestCaseEditorApp.MVVM.Domains.Shared.Views.SharedAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:TestCaseEditorApp.MVVM.Domains.Requirements.ViewModels"
             xmlns:converters="clr-namespace:TestCaseEditorApp.Converters"
             xmlns:tcgConverters="clr-namespace:TestCaseEditorApp.MVVM.Domains.TestCaseGeneration.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800"
             d:DataContext="{d:DesignInstance Type=vm:RequirementAnalysisViewModel}"
             MinHeight="200"
             UseLayoutRounding="True"
             SnapsToDevicePixels="True"
             TextOptions.TextFormattingMode="Display"
             TextOptions.TextRenderingMode="Auto"
             Background="{StaticResource Brush.Background.Menu}">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibilityConverter" />
        <converters:StringNotEmptyToVisibilityConverter x:Key="StringNotEmptyToVisibilityConverter" />
        <converters:StringEmptyToVisibilityConverter x:Key="StringEmptyToVisibilityConverter" />
        <tcgConverters:FixTextHighlightConverter x:Key="FixTextHighlightConverter" />
        <tcgConverters:BracketHighlightConverter x:Key="BracketHighlightConverter" />
        
        <!-- Inverted converter for showing content when NOT analyzing -->
        <converters:BoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" Invert="True" />
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <ScrollViewer.Resources>
            <Style TargetType="ScrollBar" BasedOn="{StaticResource CustomScrollBarStyle}"/>
        </ScrollViewer.Resources>
        
        <Grid Margin="8" MinHeight="300">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header -->
                <RowDefinition Height="Auto"/> <!-- Quality Score -->
                <RowDefinition Height="Auto"/> <!-- Issues -->
                <RowDefinition Height="Auto"/> <!-- Freeform Feedback -->
                <RowDefinition Height="*"/>    <!-- Spacer -->
            </Grid.RowDefinitions>

            <!-- No analysis yet OR analyzing - Clean, minimal interface -->
            <Grid Grid.Row="0" Grid.RowSpan="5" 
                  VerticalAlignment="Center" 
                  HorizontalAlignment="Center">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <!-- Show when no analysis OR when analyzing -->
                            <DataTrigger Binding="{Binding HasAnalysis}" Value="False">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsAnalyzing}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                
                <!-- Ready to analyze prompt - Show when NOT analyzing -->
                <StackPanel Visibility="{Binding IsAnalyzing, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                            HorizontalAlignment="Center">
                    <TextBlock Text="Ready to analyze your requirement" 
                               FontSize="16" 
                               Foreground="#CCCCCC" 
                               HorizontalAlignment="Center"
                               Margin="0,0,0,24"/>
                    
                    <!-- Analyze Now Button -->
                    <Button Command="{Binding AnalyzeRequirementCommand}"
                            Content="Analyze Now"
                            HorizontalAlignment="Center"
                            Padding="24,12"
                            FontSize="14"
                            FontWeight="SemiBold"
                            Background="#4CAF50"
                            Foreground="White"
                            BorderBrush="#45A049"
                            BorderThickness="1"
                            Cursor="Hand"/>
                </StackPanel>

                <!-- Analyzing status - Show when analyzing -->
                <StackPanel Visibility="{Binding IsAnalyzing, Converter={StaticResource BooleanToVisibilityConverter}}"
                            HorizontalAlignment="Center">
                    <Border Background="#666666"
                            BorderBrush="#555555"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="24,12"
                            HorizontalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Analyzing" 
                                       FontSize="14" 
                                       FontWeight="SemiBold"
                                       Foreground="White" 
                                       VerticalAlignment="Center"
                                       Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding AnalysisElapsedTime}" 
                                       FontSize="14" 
                                       FontWeight="SemiBold"
                                       Foreground="#AAAAAA" 
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                    
                    <ProgressBar IsIndeterminate="True" 
                                 Width="120" 
                                 Height="3" 
                                 Background="#333333"
                                 Foreground="#4CAF50"
                                 Margin="0,8,0,0"/>
                </StackPanel>
            </Grid>

            <!-- Analysis Results - Show when analysis is complete -->
            <StackPanel Grid.Row="0" Grid.RowSpan="5" 
                        Visibility="{Binding HasAnalysis, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Margin="0,16">

                <!-- Header Section with professional styling -->
                <StackPanel Margin="0,0,0,24">
                    <TextBlock Text="Requirement Quality Analysis"
                               FontSize="24"
                               FontWeight="SemiBold"
                               Foreground="#FF8C00"
                               Margin="0,0,0,4"/>
                    <TextBlock Text="{Binding AnalysisTimestamp, StringFormat='Analyzed on {0}'}"
                               FontSize="12"
                               Foreground="#AAAAAA"/>
                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                        <TextBlock Text="Original Quality Score"
                                   FontSize="12"
                                   Foreground="#CCCCCC"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding QualityScore, StringFormat='{}{0}/10'}"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   Foreground="White"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <!-- Refined Requirement Section -->
                <Border Background="#3A3A3C"
                        BorderBrush="#5A5A5C"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,16"
                        Visibility="{Binding HasImprovedRequirement, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <Grid Grid.Row="0" Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0"
                                       Text="ðŸ“"
                                       FontSize="16"
                                       VerticalAlignment="Center"
                                       Margin="0,0,8,0"/>
                            <TextBlock Grid.Column="1"
                                       Text="Refined Requirement"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="White"
                                       VerticalAlignment="Center"/>
                            <Button Grid.Column="2"
                                    Command="{Binding EditRequirementCommand}"
                                    Content="Edit"
                                    Background="Transparent"
                                    BorderBrush="#FF8C00"
                                    BorderThickness="1"
                                    Foreground="#FF8C00"
                                    FontSize="11"
                                    Padding="12,4"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Style.Triggers>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Foreground" Value="#666666"/>
                                                <Setter Property="BorderBrush" Value="#666666"/>
                                                <Setter Property="Cursor" Value="Arrow"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                        
                        <TextBlock Grid.Row="1"
                                   Text="Complete rewritten requirement addressing all identified issues:"
                                   FontSize="11"
                                   Foreground="#AAAAAA"
                                   Margin="0,0,0,8"/>
                        
                        <!-- Read-only view (when NOT editing) -->
                        <TextBlock Grid.Row="1"
                                   Text="{Binding ImprovedRequirement}"
                                   FontSize="12"
                                   Foreground="#E0E0E0"
                                   TextWrapping="Wrap"
                                   LineHeight="18"
                                   Margin="0,20,0,0"
                                   Visibility="{Binding IsEditingRequirement, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                        
                        <!-- Edit mode (when editing) -->
                        <Grid Grid.Row="1" 
                              Margin="0,20,0,0"
                              Visibility="{Binding IsEditingRequirement, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Text editing area -->
                            <TextBox Grid.Row="0"
                                     Text="{Binding EditingRequirementText, UpdateSourceTrigger=PropertyChanged}"
                                     FontSize="12"
                                     Foreground="#E0E0E0"
                                     Background="#4A4A4C"
                                     BorderBrush="#6A6A6C"
                                     BorderThickness="1"
                                     Padding="8"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     MinHeight="80"
                                     VerticalScrollBarVisibility="Auto"/>
                            
                            <!-- Edit action buttons -->
                            <StackPanel Grid.Row="1" 
                                        Orientation="Horizontal" 
                                        HorizontalAlignment="Right"
                                        Margin="0,12,0,0">
                                <!-- Copy for external analysis button -->
                                <Button Command="{Binding CopyAnalysisPromptCommand}"
                                        Content="{Binding CopyAnalysisButtonText}"
                                        Background="Transparent"
                                        BorderBrush="#4CAF50"
                                        BorderThickness="1"
                                        Foreground="#4CAF50"
                                        FontSize="11"
                                        Padding="12,4"
                                        Margin="0,0,8,0"
                                        Cursor="Hand"
                                        ToolTip="Copy current text to clipboard or generate prompt for external LLM analysis"/>
                                <Button Command="{Binding CancelEditRequirementCommand}"
                                        Content="Cancel"
                                        Background="Transparent"
                                        BorderBrush="#666666"
                                        BorderThickness="1"
                                        Foreground="#CCCCCC"
                                        FontSize="11"
                                        Padding="12,4"
                                        Margin="0,0,8,0"
                                        Cursor="Hand"/>
                                <Button Command="{Binding SaveRequirementCommand}"
                                        Content="Save"
                                        Background="#4CAF50"
                                        BorderBrush="#45A049"
                                        BorderThickness="1"
                                        Foreground="White"
                                        FontSize="11"
                                        Padding="12,4"
                                        Cursor="Hand"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Issues Section with improved styling -->
                <Border Background="#3A3A3C"
                        BorderBrush="#5A5A5C"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,16"
                        Visibility="{Binding Issues, Converter={StaticResource NullOrEmptyToVisibilityConverter}}">
                    
                    <StackPanel>
                        <TextBlock Text="Issues Identified"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="White"
                                   Margin="0,0,0,16"/>
                        
                        <ItemsControl ItemsSource="{Binding Issues}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,0,0,12">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                            <Border Background="#FF8C00"
                                                    CornerRadius="3"
                                                    Padding="8,2"
                                                    Margin="0,0,8,0">
                                                <TextBlock Text="{Binding Category}"
                                                           FontSize="11"
                                                           FontWeight="Medium"
                                                           Foreground="Black"/>
                                            </Border>
                                            <Border Background="#666666"
                                                    CornerRadius="3"
                                                    Padding="8,2">
                                                <TextBlock Text="{Binding Severity}"
                                                           FontSize="11"
                                                           Foreground="White"/>
                                            </Border>
                                        </StackPanel>
                                        <TextBlock Text="{Binding Description}"
                                                   FontSize="12"
                                                   Foreground="#E0E0E0"
                                                   TextWrapping="Wrap"
                                                   LineHeight="16"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Freeform Feedback Section -->
                <Border Background="#3A3A3C"
                        BorderBrush="#5A5A5C"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Visibility="{Binding FreeformFeedback, Converter={StaticResource StringNotEmptyToVisibilityConverter}}">
                    
                    <StackPanel>
                        <TextBlock Text="Additional Feedback"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="White"
                                   Margin="0,0,0,12"/>
                        
                        <TextBlock Text="{Binding FreeformFeedback}"
                                   FontSize="12"
                                   Foreground="#E0E0E0"
                                   TextWrapping="Wrap"
                                   LineHeight="18"/>
                    </StackPanel>
                </Border>
                
            </StackPanel>
        </Grid>
    </ScrollViewer>
</UserControl>