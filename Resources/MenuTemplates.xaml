<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!--
    DataTemplate for a main menu item that animates its sub-menu open/closed.
    Key: MainMenuWithAnimatedSubmenuTemplate
    Usage: set ItemsControl.ItemTemplate="{StaticResource MainMenuWithAnimatedSubmenuTemplate}"
    Expects each main item to expose:
      - DisplayName (string)
      - Children (IEnumerable of items that expose DisplayName)
    Relies on existing resources:
      - MenuPopupButtonStyle
      - MenuForeground
  -->

    <DataTemplate x:Key="MainMenuWithAnimatedSubmenuTemplate">
        <StackPanel>
            <!-- Main header -->
            <ToggleButton
        Content="{Binding DisplayName}"
        IsChecked="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=IsSelected, Mode=TwoWay}"
        Style="{StaticResource MenuPopupButtonStyle}" />

            <!-- Animated sub-menu using LayoutTransform so layout reflows -->
            <Border Margin="8,6,0,6" Padding="0" Background="Transparent" ClipToBounds="True">
                <Border.LayoutTransform>
                    <ScaleTransform ScaleY="0" />
                </Border.LayoutTransform>

                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Opacity" Value="0" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=IsSelected}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY"
                                       To="1"
                                       Duration="0:0:0.22"
                                       AccelerationRatio="0.2" DecelerationRatio="0.8" />
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                       To="1"
                                       Duration="0:0:0.18" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="LayoutTransform.ScaleY"
                                       To="0"
                                       Duration="0:0:0.18"
                                       AccelerationRatio="0.2" DecelerationRatio="0.8" />
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                       To="0"
                                       Duration="0:0:0.12" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <ItemsControl ItemsSource="{Binding Children}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding DisplayName}" Margin="8,4" Foreground="{StaticResource MenuForeground}" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>
        </StackPanel>
    </DataTemplate>

</ResourceDictionary>